services:
  user:
    build:
      context: .
      dockerfile: service/user/Dockerfile
    image: "${ECR_NAME:-local}/user-domain:${TAG:-latest}"
    ports:
      - "8081:8080"
    depends_on:
      local-db:
        condition: service_healthy
      local-redis:
        condition: service_started
      local-kafka:
        condition: service_started
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://local-db:5432/ecommerce
      - AWS_COGNITO_REGION=${AWS_COGNITO_REGION}
      - AWS_COGNITO_USER_POOL_ID=${AWS_COGNITO_USER_POOL_ID}
      - AWS_COGNITO_JWK_SET_URI=${AWS_COGNITO_JWK_SET_URI}
      - AWS_COGNITO_CLIENT_ID=${AWS_COGNITO_CLIENT_ID}
      - AWS_COGNITO_CLIENT_SECRET=${AWS_COGNITO_CLIENT_SECRET}
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres

  cart:
    build:
      context: .
      dockerfile: service/cart/Dockerfile
    image: "${ECR_NAME:-local}/cart-domain:${TAG:-latest}"
    ports:
      - "8082:8080"
    depends_on:
      local-db:
        condition: service_healthy
      local-redis:
        condition: service_started
      local-kafka:
        condition: service_started
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - REDIS_HOST=local-redis
      - PRODUCT_SERVICE_URL=http://product:8080
      - SERVER_PORT=8080
      - COGNITO_JWK_SET_URI=${COGNITO_JWK_SET_URI}
      - AWS_COGNITO_JWK_SET_URI=${AWS_COGNITO_JWK_SET_URI}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://local-db:5432/ecommerce
      - DB_HOST=local-db
      - DB_PORT=5432
      - DB_NAME=ecommerce
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres

  order:
    build:
      context: .
      dockerfile: service/order/Dockerfile
    image: "${ECR_NAME:-local}/order-domain:${TAG:-latest}"
    ports:
      - "8083:8080"
    depends_on:
      local-db:
        condition: service_healthy
      local-redis:
        condition: service_started
      local-kafka:
        condition: service_started
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - USER_SERVICE_URL=http://user:8080
      - PRODUCT_SERVICE_URL=http://product:8080
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://local-db:5432/ecommerce
      - AWS_COGNITO_JWK_SET_URI=${AWS_COGNITO_JWK_SET_URI}
      - DB_HOST=local-db
      - DB_PORT=5432
      - DB_NAME=ecommerce
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres

  payment:
    build:
      context: .
      dockerfile: service/payment/Dockerfile
    image: "${ECR_NAME:-local}/payment-domain:${TAG:-latest}"
    ports:
      - "8084:8080"
    depends_on:
      local-db:
        condition: service_healthy
      local-redis:
        condition: service_started
      local-kafka:
        condition: service_started
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://local-db:5432/ecommerce
      - AWS_COGNITO_JWK_SET_URI=${AWS_COGNITO_JWK_SET_URI}
      - DB_HOST=local-db
      - DB_PORT=5432
      - DB_NAME=ecommerce
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres

  product:
    build:
      context: .
      dockerfile: service/product/Dockerfile
    image: "${ECR_NAME:-local}/product-domain:${TAG:-latest}"
    ports:
      - "8085:8080"
    depends_on:
      local-db:
        condition: service_healthy
      local-redis:
        condition: service_started
      local-kafka:
        condition: service_started
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - KAFKA_BOOTSTRAP_SERVERS=${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://local-db:5432/ecommerce
      - AWS_COGNITO_JWK_SET_URI=${AWS_COGNITO_JWK_SET_URI}
      - DB_HOST=local-db
      - DB_PORT=5432
      - DB_NAME=ecommerce
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres

  # 1) PostgreSQL
  local-db:
    image: postgres:15-alpine
    container_name: local-db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ecommerce
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5


  # 2) Redis
  local-redis:
    image: redis:alpine
    container_name: local-redis
    ports:
      - "6379:6379"

  # 3) Kafka (single-node, KRaft mode for local development)
  local-kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: local-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://local-kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@local-kafka:9093
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - kafka_data:/var/lib/kafka/data

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8090:8080"
    depends_on:
      local-kafka:
        condition: service_started
    environment:
      KAFKA_CLUSTERS_0_NAME: local-kafka-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: ${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-local-kafka:9092}
      DYNAMIC_CONFIG_ENABLED: true

volumes:
  kafka_data:
